package cz.ondrejsmetak.entity;

import cz.ondrejsmetak.tool.Helper;
import cz.ondrejsmetak.tool.Log;
import java.io.ByteArrayInputStream;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Kdyz server posila svuj certifikat behem SSL/TLS handshake
 *
 *
 * @author Ondřej Směták <posta@ondrejsmetak.cz>
 */
public class ServerCertificate extends BasePayloadEntity {

	private Hex contentType;
	private Hex versionLayer;
	private Hex lengthLayer;

	private Hex handshakeType;
	private Hex lengthHandshake;

	private Hex lengthCertificates;

	public static ServerCertificateCheck NO_SERVER_CERTIFICATE = null;
	private final List<X509Certificate> certificates = new ArrayList<>();

	public ServerCertificate(byte[] bytes) {
		parse(bytes);
	}

	private void parse(byte[] bytes) {
		int i = 0;

		/*SSL/TLS layer*/
		contentType = new Hex(bytes[i++]);
		versionLayer = new Hex(bytes[i++], bytes[i++]);
		lengthLayer = new Hex(bytes[i++], bytes[i++]);

		/*Handshake protocol*/
		handshakeType = new Hex(bytes[i++]);
		lengthHandshake = new Hex(bytes[i++], bytes[i++], bytes[i++]);

		/*Certificates*/
		lengthCertificates = new Hex(bytes[i++], bytes[i++], bytes[i++]);
		int lengthCertificatesDec = Helper.hexToDec(lengthCertificates);

		while (lengthCertificatesDec > 0) {
			//cteme nespecifikovany pocet certifikatu v chainu

			Hex lengthCertificate = new Hex(bytes[i++], bytes[i++], bytes[i++]); //prvni 3 bajty vzdy velikost toho, co se bude cist
			int lengthCertificateDec = Helper.hexToDec(lengthCertificate);

			
			
			System.err.println("Ctu: " + Helper.toHexString(Arrays.copyOfRange(bytes, i, i + lengthCertificateDec)));
			//System.err.println("Delka: " + lengthCertificateDec);
			X509Certificate x509 = decodeCertificate(Arrays.copyOfRange(bytes, i, i + lengthCertificateDec));
			
			
			if (x509 != null) {
				certificates.add(x509);
				//System.err.println(x509.getSubjectX500Principal().getName());
				try {
					x509.getEncoded();
					//System.err.println(Helper.toHexString(x509.getEncoded()));
				} catch (CertificateEncodingException ex) {
					ex.printStackTrace();
					Logger.getLogger(ServerCertificate.class.getName()).log(Level.SEVERE, null, ex);
				}
			}

			i += lengthCertificateDec;

			lengthCertificatesDec -= 3;
			lengthCertificatesDec -= lengthCertificateDec;
		}
	}

	public void clearCertificates() {
		certificates.clear();
	}

	public void addCertificate(X509Certificate certificate) {
		certificates.add(certificate);
	}

	public int getCertificatesLength() throws CertificateEncodingException {
		int length = 0;

		for (X509Certificate certificate : certificates) {
			Hex c = new Hex(certificate.getEncoded());
			length += c.getLengthInDec();
		}

		return length;
	}

	public String getPrint() {
		StringBuilder sb = new StringBuilder();
		for (X509Certificate certificate : certificates) {
			sb.append(certificate.getSubjectX500Principal().getName());
		}

		return sb.toString();
	}

	public void hack() {
		clearCertificates();
		
		//jak funguje https://security.stackexchange.com/questions/79482/whats-the-purpose-of-server-key-exchange-when-using-ephemeral-diffie-hellman
		//server key exchange
		
		//is.ssos.cz
		//addCertificate(decodeCertificate(Helper.toByteArray("30820357308202C0A00302010202021046300D06092A864886F70D01010505003081C2310B300906035504061302435A311730150603550408130E437A6563682052657075626C69633110300E060355040713074872616E696365311E301C060355040A131553534F53204872616E6963652C20732E20722E206F31233021060355040B131A53534F5320436572746966696361746520417574686F72697479312530230603550403131C53534F532043657274696669636174696F6E20417574686F72697479311C301A06092A864886F70D010901160D66696C69704073736F732E637A301E170D3136303331353137343035335A170D3137303331353137343035335A3081A1310B300906035504061302435A311730150603550408130E437A6563682072657075626C69633110300E060355040713074872616E696365311F301D060355040A131653534F53204872616E6963652C20732E20722E206F2E31133011060355040B130A69732E73736F732E637A311330110603550403130A69732E73736F732E637A311C301A06092A864886F70D010901160D66696C69704073736F732E637A30819F300D06092A864886F70D010101050003818D0030818902818100C5654C92A4ABA702BE4996CD65402FEFDFA042B95E7F94752A0030AE94F43DA88EB30B1820A31ACC85F9D3F6CA61AEA1C08AC2ED9AC9667B81E397D1ACA891A03E459EFA720F5171A9557967C9D112BED5CD901D94FB53899AB7049A5633F51D158E4D485904577D8D7520A30D76D39BB6956E170084964E23B62E4274E067750203010001A37B307930090603551D1304023000302C06096086480186F842010D041F161D4F70656E53534C2047656E657261746564204365727469666963617465301D0603551D0E04160414BD09AAF864BECD6688CF66590461D94EBAD90EA0301F0603551D23041830168014D76EFEBEE1DE5A76CBA4F1FF2FD1567CCFFCF32B300D06092A864886F70D010105050003818100B48A4678269C701BCF05478DD0EFBA19237D9EAAA28DEF437E534CCCCD4E283443B4CFBE7289894F120707CC995D16DFC17A94D56ABF8DFD2AD4340930C1589B201879C46D51820DAA202C6BA86DDCF0E507E64C2FACD5F5654278CBED0A81080F7A33630CE3E90FEBE3A3C2A017BEC23FB32F2F7B3047696641CABE3638FAA9")));
		
		//seznam
		//addCertificate(decodeCertificate(Helper.toByteArray("3082062E30820516A0030201020210246A6557BD67777291D536E4EFDEEAA6300D06092A864886F70D01010B05003044310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311E301C060355040313157468617774652045562053534C204341202D204733301E170D3136313231343030303030305A170D3137313232313233353935395A3081CE31133011060B2B0601040182373C0201031302435A31183016060355040A0C0F53657A6E616D2E637A2C20612E732E310B300906035504061302435A311B301906035504080C12486C61766E69206D6573746F2050726168613110300E06035504070C0750726168612035311D301B060355040F131450726976617465204F7267616E697A6174696F6E3111300F06035504051308323631363836383531173015060355040B0C0E53797374656D20537570706F72743116301406035504030C0D7777772E73657A6E616D2E637A30820122300D06092A864886F70D01010105000382010F003082010A0282010100C5188B686B62588E8BDE783EFA746D28FC734AC994042BB1A14768FF8FF8350E01519142B5F45DAC45048BEB052CC7336CD3A38CACC1269713990A9C69BD10BDEF8BCB5F8DAFEB1A9A26073ABEE9D4D25AE2BA5CBD39CE5F3380E0A4D1B5BCBD734678C5235A0B77100AB95A659F333D2BD79D94E244F1878C61D70905ABD5C7D34E20CD2D1B127293F7A12207F4985B275DEFD89647F2F1B86B7DFC170DE6D03C04D48AC47BA4A115FE38C65E328B6BC4F32BE9ED02A75A67E686A8D6AB8CCC68381099EE49FB9B438A8E7F7282B52A6CE2FC69A13F74B1B4655FC60F4A71E5824F61C3D96B9EC206C8D97B631001F7C338D9EE3B28F6830D13B01A43F8505D0203010001A382028F3082028B30230603551D11041C301A820973657A6E616D2E637A820D7777772E73657A6E616D2E637A30090603551D1304023000300E0603551D0F0101FF0404030205A0302B0603551D1F042430223020A01EA01C861A687474703A2F2F74692E73796D63622E636F6D2F74692E63726C307C0603551D20047530733068060B6086480186F845010730013059302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F637073302F06082B0601050507020230230C2168747470733A2F2F7777772E7468617774652E636F6D2F7265706F7369746F72793007060567810C0101301D0603551D250416301406082B0601050507030106082B06010505070302301F0603551D23041830168014F07051DAD32A914F5277D78677740FCE711A6C22305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F74692E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F74692E73796D63622E636F6D2F74692E63727430820103060A2B06010401D6790204020481F40481F100EF007600DDEB1D2B7A0D4FA6208B81AD8168707E2E8E9D01D55C888D3D11C4CDB6ECBECC00000158FC8AC54F0000040300473045022100891DA6FC02F88CB58E700999DC137C1A95D7B9F39B791FFBAF4DB283731FD1AC0220692D82ACD23C0AC6C4312069B1B2816F5641F2EA40A353088F23A7B4D3F3D5E4007500EE4BBDB775CE60BAE142691FABE19E66A30F7E5FB072D88300C47B897AA8FDCB00000158FC8AC5A000000403004630440220446CECB55AF08089A702F57DE85FACD9372FAD92E4D58BCE9CF2EF78C0EAFE2A02200F80C796EFBFB908A36F49C0C6970D79DF2BC0E872AD904751BA705945A90D32300D06092A864886F70D01010B0500038201010047EF86094CF04116F3603D183FE0BD70A8467ADC637E319B6472B6139048537915E93CD8AC5D6F2B1F6F2DF6BF598E126EA37F358ECE38B2E76AB0D42439CF91C8F664EFE969EC46730EB544E01A85C73365F4B2395EEAD5910595E706AB071640320D05F97C7865D8349ED5D5C961E7B5DB5E736DD76F55FEBF6631A7B2140D6010C10FB3516792406A1DB8720D5F083F99ACAB6DBDC8C395E8D7FB677370803EF587C647E068F51BE1A1C5933E614A2B430C6EFA568E4605F706D84CDE6843D8C7F2AADD8037F712F1B6F44BFAE09EDBF148A0415AB4C0E7BB1155D414E8B0116EE1C2264DC1BDDD2F5946348C034FA344D079E539E6615F59B0976CD32A08")));
		//addCertificate(decodeCertificate(Helper.toByteArray("308204AF30820397A00302010202105D72FB337620F64C7280DBE91281FF6A300D06092A864886F70D01010B05003081A9310B300906035504061302555331153013060355040A130C7468617774652C20496E632E31283026060355040B131F43657274696669636174696F6E205365727669636573204469766973696F6E31383036060355040B132F2863292032303036207468617774652C20496E632E202D20466F7220617574686F72697A656420757365206F6E6C79311F301D06035504031316746861777465205072696D61727920526F6F74204341301E170D3133313033313030303030305A170D3233313033303233353935395A3044310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311E301C060355040313157468617774652045562053534C204341202D20473330820122300D06092A864886F70D01010105000382010F003082010A0282010100C4DDDA941E32B22EA083C0A67D5F652DFD27B8730EF80BA9D4562669986735396458CE826F9894D18FE090D6ED554B984BD7105934021BE7513151C438C2BCDB035CCAE17CDC4F5997EA077F0F853E92EAAAA7D9BE0141E462564736BD5791E621D3F8410BD8BAE8ED81AD70C08B6EF3896E279EA6A67359BB7100D44F4B48E9D5C927369C7C1C02AAACBD3BD153836A1FE6084733A7B19F02BE9B47ED3304DC1C8027D14A33A08CEB0147A13290647BC4E084C932E9DD341F8A6867F3AD1063EBEE8A9AB12A1B2674A12AB08FFE52984697CFA3561C6F6E99978D260EA9ECC25370FC7AA51949BDB5178255DE97E05D628481F070A834534F14FD3D5D3D6FB90203010001A38201353082013130120603551D130101FF040830060101FF020100300E0603551D0F0101FF040403020106302F06082B0601050507010104233021301F06082B060105050730018613687474703A2F2F74322E73796D63622E636F6D303B0603551D200434303230300604551D20003028302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F63707330320603551D1F042B30293027A025A0238621687474703A2F2F74312E73796D63622E636F6D2F5468617774655043412E63726C30290603551D1104223020A41E301C311A30180603550403131153796D616E746563504B492D312D353336301D0603551D0E04160414F07051DAD32A914F5277D78677740FCE711A6C22301F0603551D230418301680147B5B45CFAFCECB7AFD31921A6AB6F346EB574850300D06092A864886F70D01010B05000382010100A12E943E9B16F4581A6FC1FAC17E4393B2C3F789EB13625DDDCC61132B1D4E8879116214373046FF896210852A871EF8E2AFFE930293CAF2E946036BA11AACD5F0801B986FB83A50F854710603E784CC8E61D25F4D0C970265B58C26BC0598F4DCC6AFE4577FE3DCA1D727472AE02C3F0974DC5AE5B57CFA829A15FA742B842E6BACEF35A630FA474AAA3644F65A9107D3E44E973FA653D82933326F8B3DB5A50DE5E48AE8F5C0FAAFD8372827C3ED3431D97CA6AF4D124FD02B929C6995F228A6FEA8C6E02C4D36EB1134D6E181999D41F2E7C557050E19CAAF42391FA7275EE00A17B8AE47AB92F18A04DF30E0BB4F8AF91B884F03B4257A78DE2E7D29D131")));
		
		//lide.cz
		//addCertificate(decodeCertificate(Helper.toByteArray("308205C6308204AEA003020102021063C139AA6B0B7AC58FFED60A9B7F32F7300D06092A864886F70D01010B05003041310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311B3019060355040313127468617774652053534C204341202D204732301E170D3137303131303030303030305A170D3138303131303233353935395A3075310B300906035504061302435A310E300C06035504080C055072616861310E300C06035504070C05507261686131173015060355040A0C0E45636F6E6F6D69612C20612E732E31163014060355040B0C0D4954204F7065726174696F6E733115301306035504030C0C2A2E63656E7472756D2E637A30820122300D06092A864886F70D01010105000382010F003082010A0282010100D7DCCAC140E28C9660ED7EF5DA23745FF5314910459F1B04FE287D3F71B5D5A247C7838C05379308D691099CC52B977E58DBC6F4870C4ECF0607B3F8C95DB8D947BC233521F62C0A645745A34F363A3F0012CF65DE9CD5F5F4D9DBAFA2ADD5945875205CBC94D3B150CB6E3FC5BB18C8F08D73AC9E75BE159CB419FC410F7CAC583816B452FB2B80C00310734F02A8B375E4801897006FE602D7F11796DF8771938E7DA31998380C34022BF1DD62C63AE4486C9B1682A271F36FF9C03A31D010B2C3D93D2C3E36C766DFB9F8BC6504A8B81BF4B2C38055AB0BACEEF5EA01112F989F5FE2BDB45056C24EFEFE76BA798F8F2E1D2BF24F14199F9E8A3A18AAC5F10203010001A38202843082028030230603551D11041C301A820C2A2E63656E7472756D2E637A820A63656E7472756D2E637A30090603551D1304023000306E0603551D20046730653063060667810C0102023059302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F637073302F06082B0601050507020230230C2168747470733A2F2F7777772E7468617774652E636F6D2F7265706F7369746F7279300E0603551D0F0101FF0404030205A0301F0603551D23041830168014C24F4857FCD14F9AC05D387D0E05DBD92EB55260302B0603551D1F042430223020A01EA01C861A687474703A2F2F746A2E73796D63622E636F6D2F746A2E63726C301D0603551D250416301406082B0601050507030106082B06010505070302305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F746A2E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F746A2E73796D63622E636F6D2F746A2E63727430820106060A2B06010401D6790204020481F70481F400F2007700DDEB1D2B7A0D4FA6208B81AD8168707E2E8E9D01D55C888D3D11C4CDB6ECBECC000001598909417E0000040300483046022100F29CC9DC09DE3A9F7DC3BE09EE7A1C3322BA0EBC6CC7BD70E8D73C1F0DD88E53022100DC23B77ED209A16E396C4D98F6F604EE85B665E1076C398D08452321A865F98A007700A4B90990B418581487BB13A2CC67700A3C359804F91BDFB8E377CD0EC80DDC1000000159890943250000040300483046022100DAFF3D9EAD5FC53549F872D65AC1E7C889CE0FF1B42141D7BCF8F09F8478E1E1022100BDD57B3F96B830FAAAA45581F1A374129A2405FF1B7FAEAC1E8756D92EA8E56C300D06092A864886F70D01010B0500038201010074F17A99C69ADDA2744CA14662B70C90B9DDFC3416E3DF39C4158128C6193C52D5A38DF7A1B5BA4684FF8113D6F8D63442A83AC1F3BEC519E1B2C31AEBADD91608B9EBE4C6F45555F14B7A1835083DD1EFAAE1260C3FD92DAC9C72526F88FB6350DB63CEDE73C2E82DAF649054FBA0576C9B784FF7CDBB968FFB62FD7A9F5A3B1BADFFDFC9FF0DCEDC1B81C34E6FE84B0629B8B0EC5F06FBBEEB89B2507AE3FAD62AFC9229E31BCFF3CA00F1277C17A48D5F10D7C64F1D49D38BF4542DF2ADD9C172462BFE28E401D957A301FA650FDC1E5FD9F9E7A9836524F3862FB2D48DDBA9A5D1C923F5433381C005FB96908B1BB9A984484F9AFE071DB2DF4AB253E397")));
		//addCertificate(decodeCertificate(Helper.toByteArray("308204B23082039AA00302010202101687D6886DE2300685233DBF11BF6597300D06092A864886F70D01010B05003081A9310B300906035504061302555331153013060355040A130C7468617774652C20496E632E31283026060355040B131F43657274696669636174696F6E205365727669636573204469766973696F6E31383036060355040B132F2863292032303036207468617774652C20496E632E202D20466F7220617574686F72697A656420757365206F6E6C79311F301D06035504031316746861777465205072696D61727920526F6F74204341301E170D3133313033313030303030305A170D3233313033303233353935395A3041310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311B3019060355040313127468617774652053534C204341202D20473230820122300D06092A864886F70D01010105000382010F003082010A0282010100B2FC06FB0493D2EA59203B4485975239E710F07AE0B09440DA46F80C28BBB9CE60383FD2D811421B91AD49EE8FC7DE6CDE376FFD8B203C6DE774D3DCD52488418089EE36BEC4D5BE8D5313AAE4A5B8930ABEECDACD3CD43256EFD04EA0B897BB39501E6E65C3FDB2CEE059A94809C6FEBEAEFC3E3B8120978B8F46DF60640775BB1B86389F477B34CEA1D197AD76D89FB726DB79803648F2C537F8D932AE7CA45381C799A154382F4F75A0BB5AA5BBCDAC025B1902D51318A7CEAC745512058B9BA29546647238CD5A1B3A16A7BE71998C5403B8966C01D33E06983F21813B027E004753011E0E4643FB4B2DDC0B1AE82F98F87ED199AB136CA417DE6FF615F50203010001A382013B3082013730120603551D130101FF040830060101FF020100300E0603551D0F0101FF04040302010630320603551D1F042B30293027A025A0238621687474703A2F2F74312E73796D63622E636F6D2F5468617774655043412E63726C302F06082B0601050507010104233021301F06082B060105050730018613687474703A2F2F74322E73796D63622E636F6D30410603551D20043A30383036060A6086480186F8450107363028302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F63707330290603551D1104223020A41E301C311A30180603550403131153796D616E746563504B492D312D353337301D0603551D0E04160414C24F4857FCD14F9AC05D387D0E05DBD92EB55260301F0603551D230418301680147B5B45CFAFCECB7AFD31921A6AB6F346EB574850300D06092A864886F70D01010B050003820101008D06DE43C97602CAD923975EF363D77D44C20F6B0AF507E58BB8FAE0A3FA6B8092B5032CC537E0C2E595B5927018284294EE4B776A010F8B23EC564DF40069E584C8E2EADE5B3EF63C073A94CA6C27B1CC831A607127D2BF02F51E44D348D5A6D37621009CFA9864EB17363FEB1B3C3EA6B1D958060E72D968BEF1A720D752E4A4771F71709D55358537E11D4D94C2707F95406E4B7DB2B4292A0379C8B94C676104A08B27FF5900EB557FC6B733352D5E4EACB8EA12C5E8F7B9ABBE74922CB7D94DCA842F1CC2F0727CB2316ECF80E5880736517BBA61AF6D8D235B34A395BCA2317FF2F5E7B7E8EFC4B52732E9F79E69C72BE8BEBB0CAAE7EA6012EA268A78")));
		
		//centrum
		addCertificate(decodeCertificate(Helper.toByteArray("308205C6308204AEA003020102021063C139AA6B0B7AC58FFED60A9B7F32F7300D06092A864886F70D01010B05003041310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311B3019060355040313127468617774652053534C204341202D204732301E170D3137303131303030303030305A170D3138303131303233353935395A3075310B300906035504061302435A310E300C06035504080C055072616861310E300C06035504070C05507261686131173015060355040A0C0E45636F6E6F6D69612C20612E732E31163014060355040B0C0D4954204F7065726174696F6E733115301306035504030C0C2A2E63656E7472756D2E637A30820122300D06092A864886F70D01010105000382010F003082010A0282010100D7DCCAC140E28C9660ED7EF5DA23745FF5314910459F1B04FE287D3F71B5D5A247C7838C05379308D691099CC52B977E58DBC6F4870C4ECF0607B3F8C95DB8D947BC233521F62C0A645745A34F363A3F0012CF65DE9CD5F5F4D9DBAFA2ADD5945875205CBC94D3B150CB6E3FC5BB18C8F08D73AC9E75BE159CB419FC410F7CAC583816B452FB2B80C00310734F02A8B375E4801897006FE602D7F11796DF8771938E7DA31998380C34022BF1DD62C63AE4486C9B1682A271F36FF9C03A31D010B2C3D93D2C3E36C766DFB9F8BC6504A8B81BF4B2C38055AB0BACEEF5EA01112F989F5FE2BDB45056C24EFEFE76BA798F8F2E1D2BF24F14199F9E8A3A18AAC5F10203010001A38202843082028030230603551D11041C301A820C2A2E63656E7472756D2E637A820A63656E7472756D2E637A30090603551D1304023000306E0603551D20046730653063060667810C0102023059302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F637073302F06082B0601050507020230230C2168747470733A2F2F7777772E7468617774652E636F6D2F7265706F7369746F7279300E0603551D0F0101FF0404030205A0301F0603551D23041830168014C24F4857FCD14F9AC05D387D0E05DBD92EB55260302B0603551D1F042430223020A01EA01C861A687474703A2F2F746A2E73796D63622E636F6D2F746A2E63726C301D0603551D250416301406082B0601050507030106082B06010505070302305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F746A2E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F746A2E73796D63622E636F6D2F746A2E63727430820106060A2B06010401D6790204020481F70481F400F2007700DDEB1D2B7A0D4FA6208B81AD8168707E2E8E9D01D55C888D3D11C4CDB6ECBECC000001598909417E0000040300483046022100F29CC9DC09DE3A9F7DC3BE09EE7A1C3322BA0EBC6CC7BD70E8D73C1F0DD88E53022100DC23B77ED209A16E396C4D98F6F604EE85B665E1076C398D08452321A865F98A007700A4B90990B418581487BB13A2CC67700A3C359804F91BDFB8E377CD0EC80DDC1000000159890943250000040300483046022100DAFF3D9EAD5FC53549F872D65AC1E7C889CE0FF1B42141D7BCF8F09F8478E1E1022100BDD57B3F96B830FAAAA45581F1A374129A2405FF1B7FAEAC1E8756D92EA8E56C300D06092A864886F70D01010B0500038201010074F17A99C69ADDA2744CA14662B70C90B9DDFC3416E3DF39C4158128C6193C52D5A38DF7A1B5BA4684FF8113D6F8D63442A83AC1F3BEC519E1B2C31AEBADD91608B9EBE4C6F45555F14B7A1835083DD1EFAAE1260C3FD92DAC9C72526F88FB6350DB63CEDE73C2E82DAF649054FBA0576C9B784FF7CDBB968FFB62FD7A9F5A3B1BADFFDFC9FF0DCEDC1B81C34E6FE84B0629B8B0EC5F06FBBEEB89B2507AE3FAD62AFC9229E31BCFF3CA00F1277C17A48D5F10D7C64F1D49D38BF4542DF2ADD9C172462BFE28E401D957A301FA650FDC1E5FD9F9E7A9836524F3862FB2D48DDBA9A5D1C923F5433381C005FB96908B1BB9A984484F9AFE071DB2DF4AB253E397")));
		//addCertificate(decodeCertificate(Helper.toByteArray("308204B23082039AA00302010202101687D6886DE2300685233DBF11BF6597300D06092A864886F70D01010B05003081A9310B300906035504061302555331153013060355040A130C7468617774652C20496E632E31283026060355040B131F43657274696669636174696F6E205365727669636573204469766973696F6E31383036060355040B132F2863292032303036207468617774652C20496E632E202D20466F7220617574686F72697A656420757365206F6E6C79311F301D06035504031316746861777465205072696D61727920526F6F74204341301E170D3133313033313030303030305A170D3233313033303233353935395A3041310B300906035504061302555331153013060355040A130C7468617774652C20496E632E311B3019060355040313127468617774652053534C204341202D20473230820122300D06092A864886F70D01010105000382010F003082010A0282010100B2FC06FB0493D2EA59203B4485975239E710F07AE0B09440DA46F80C28BBB9CE60383FD2D811421B91AD49EE8FC7DE6CDE376FFD8B203C6DE774D3DCD52488418089EE36BEC4D5BE8D5313AAE4A5B8930ABEECDACD3CD43256EFD04EA0B897BB39501E6E65C3FDB2CEE059A94809C6FEBEAEFC3E3B8120978B8F46DF60640775BB1B86389F477B34CEA1D197AD76D89FB726DB79803648F2C537F8D932AE7CA45381C799A154382F4F75A0BB5AA5BBCDAC025B1902D51318A7CEAC745512058B9BA29546647238CD5A1B3A16A7BE71998C5403B8966C01D33E06983F21813B027E004753011E0E4643FB4B2DDC0B1AE82F98F87ED199AB136CA417DE6FF615F50203010001A382013B3082013730120603551D130101FF040830060101FF020100300E0603551D0F0101FF04040302010630320603551D1F042B30293027A025A0238621687474703A2F2F74312E73796D63622E636F6D2F5468617774655043412E63726C302F06082B0601050507010104233021301F06082B060105050730018613687474703A2F2F74322E73796D63622E636F6D30410603551D20043A30383036060A6086480186F8450107363028302606082B06010505070201161A68747470733A2F2F7777772E7468617774652E636F6D2F63707330290603551D1104223020A41E301C311A30180603550403131153796D616E746563504B492D312D353337301D0603551D0E04160414C24F4857FCD14F9AC05D387D0E05DBD92EB55260301F0603551D230418301680147B5B45CFAFCECB7AFD31921A6AB6F346EB574850300D06092A864886F70D01010B050003820101008D06DE43C97602CAD923975EF363D77D44C20F6B0AF507E58BB8FAE0A3FA6B8092B5032CC537E0C2E595B5927018284294EE4B776A010F8B23EC564DF40069E584C8E2EADE5B3EF63C073A94CA6C27B1CC831A607127D2BF02F51E44D348D5A6D37621009CFA9864EB17363FEB1B3C3EA6B1D958060E72D968BEF1A720D752E4A4771F71709D55358537E11D4D94C2707F95406E4B7DB2B4292A0379C8B94C676104A08B27FF5900EB557FC6B733352D5E4EACB8EA12C5E8F7B9ABBE74922CB7D94DCA842F1CC2F0727CB2316ECF80E5880736517BBA61AF6D8D235B34A395BCA2317FF2F5E7B7E8EFC4B52732E9F79E69C72BE8BEBB0CAAE7EA6012EA268A78")));
	}

	public Hex toHex() throws CertificateEncodingException {
		/**
		 * Size of certificate + 3 bytes to store each certificate size
		 */
		int certificatesLength = getCertificatesLength() + (3 * certificates.size());

		StringBuilder sb = new StringBuilder();
		sb.append(contentType);
		sb.append(versionLayer);
		sb.append(new Hex(Helper.decToHex(certificatesLength + 7), 2));

		sb.append(handshakeType);
		sb.append(new Hex(Helper.decToHex(certificatesLength + 3), 3));

		sb.append(new Hex(Helper.decToHex(certificatesLength), 3));

		for (X509Certificate certificate : certificates) {
			Hex c = new Hex(certificate.getEncoded());
			sb.append(new Hex(c.getLengthInHex(), 3)); //length of single certificate
			sb.append(c.toString());
			
			//System.out.println("Pridavam certifikat: " + c.toString());
		}

		return new Hex(sb.toString());
	}

	private X509Certificate decodeCertificate(byte[] bytes) {
		try {
			CertificateFactory cf = CertificateFactory.getInstance("X.509");
			return (X509Certificate) cf.generateCertificate(new ByteArrayInputStream(bytes));
		} catch (CertificateException ex) {
			Log.debugException(ex);
			return null;
		}
	}

	public static ServerCertificateCheck isServerCerfificate(byte[] bytes) {
		//we need at least 6 bytes to determine
		if (bytes.length < 6) {
			return NO_SERVER_CERTIFICATE;
		}

		for (int i = 0; i < bytes.length; i++) {
			if (i + 5 >= bytes.length) { //out of bouds
				break;
			}

			Hex contentType = new Hex(bytes[i]);
			Hex versionLayer = new Hex(bytes[i + 1], bytes[i + 2]);
			Hex lengthLayer = new Hex(bytes[i + 3], bytes[i + 4]);
			int lengthLayerDec = Helper.hexToDec(lengthLayer);

			Hex handshakeType = new Hex(bytes[i + 5]);

			boolean found = contentType.equals(CONTENT_TYPE)
					&& getAllVersions().contains(versionLayer)
					&& handshakeType.equals(HANDSHAKE_TYPE_CERTIFICATE);

			if (found) {
				//+5 is size for contentType, versionLayer and LengthLayer
				return new ServerCertificateCheck(i, i + lengthLayerDec + 5);
				//return Arrays.copyOfRange(bytes, i, i + lengthLayerDec);
			}
		}

		return NO_SERVER_CERTIFICATE;
	}

	public static class ServerCertificateCheck {

		private int startIndex;
		private int endIndex;

		public ServerCertificateCheck(int startIndex, int endIndex) {
			this.startIndex = startIndex;
			this.endIndex = endIndex;
		}

		public int getStartIndex() {
			return startIndex;
		}

		public int getEndIndex() {
			return endIndex;
		}

		public int getLength() {
			return endIndex - startIndex;
		}

	}

}
